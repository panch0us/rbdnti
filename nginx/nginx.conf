events {
    worker_connections 1024;  # Максимальное количество соединений на worker
}

http {
    include /etc/nginx/mime.types;  # Подключаем стандартные MIME типы
    default_type application/octet-stream;  # Тип по умолчанию для неизвестных файлов

    server {
        listen 80;       # Слушать порт 80
        server_name _;   # Принимать запросы на любом домене

        # СТАТИЧЕСКИЕ ФАЙЛЫ - nginx отдает их напрямую (быстро)
        location /static/ {
            alias /static/;           # Папка со статикой в контейнере
            expires 7d;               # Кэшировать в браузере 7 дней
            add_header Cache-Control "public";  # Разрешить кэширование
            access_log off;           # Не логировать запросы к статике
        }

        # МЕДИА ФАЙЛЫ - загруженные пользователями
        location /media/ {
            alias /media/;            # Папка с медиа в контейнере
            expires 7d;               # Кэшировать в браузере 7 дней
            add_header Cache-Control "public";
            access_log off;
        }

        # ВСЕ ОСТАЛЬНЫЕ ЗАПРОСЫ - проксируем в Django
        location / {
            proxy_pass http://web:8000;  # Перенаправляем в контейнер web на порт 8000
            
            # Передаем заголовки для корректной работы Django:
            proxy_set_header Host $host;              # Оригинальный Host
            proxy_set_header X-Real-IP $remote_addr;  # Реальный IP клиента
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка прокси
            proxy_set_header X-Forwarded-Proto $scheme;  # Протокол (http/https)
            
            proxy_read_timeout 120;    # Таймаут чтения 120 секунд
            proxy_connect_timeout 5s;  # Таймаут подключения 5 секунд
        }
    }
}