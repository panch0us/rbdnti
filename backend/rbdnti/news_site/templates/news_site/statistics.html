{% extends "news_site/base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –†–ë–î –ù–¢–ò{% endblock %}

{% block content %}
<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<nav class="breadcrumb">
    <span class="breadcrumb-item">
        <a href="{% url 'news_site:index' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    </span>
    <span class="breadcrumb-item active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
</nav>

<h1 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –†–ë–î –ù–¢–ò</h1>

<!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º -->
<div class="stats-container">
    <h3>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h3>
    <form method="get" class="date-filter-form">
        <div class="filter-row">
            <div class="filter-group">
                <label for="start_date">–°:</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="filter-group">
                <label for="end_date">–ü–æ:</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <button type="submit" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
            <a href="{% url 'news_site:statistics' %}" class="filter-btn reset">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </div>
        <div class="filter-help">
        {% if start_date or end_date %}
            –ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–µ—Ä–∏–æ–¥: 
            {% if start_date %}{{ start_date }}{% else %}–Ω–∞—á–∞–ª–∞ –≤—Ä–µ–º–µ–Ω{% endif %} 
            - 
            {% if end_date %}{{ end_date }}{% else %}—Å–µ–≥–æ–¥–Ω—è{% endif %}
        {% else %}
            –ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        {% endif %}
        </div>
    </form>
</div>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-container">
    <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ unique_users }}</div>
            <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_news_period }}</div>
            <div class="stat-label">–ù–æ–≤–æ—Å—Ç–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_views_period }}</div>
            <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_downloads_period }}</div>
            <div class="stat-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º -->
    {% if subdivision_stats %}
    <div class="subdivision-stats">
        <h4>üìä –†–∞–∑–º–µ—â–µ–Ω–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º–∏</h4>
        <div class="subdivision-list">
            {% for subdivision, count in subdivision_stats.items %}
            <div class="subdivision-item">
                <span class="subdivision-name">{{ subdivision }}</span>
                <span class="subdivision-count">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
<div class="stats-container">
    <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
    
    <form method="get" class="detailed-stats-form">
        <!-- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∞—Ç -->
        {% if start_date %}<input type="hidden" name="start_date" value="{{ start_date }}">{% endif %}
        {% if end_date %}<input type="hidden" name="end_date" value="{{ end_date }}">{% endif %}
        
        <div class="form-row">
            <div class="form-group">
                <label for="section_select">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</label>
                <select id="section_select" name="section_id" onchange="this.form.submit()">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª --</option>
                    {% for section in all_sections %}
                    <option value="{{ section.id }}" {% if selected_section_id == section.id|stringformat:"i" %}selected{% endif %}>
                        {{ section.title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        {% if selected_section %}
        <div class="form-row">
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
                <div class="analysis-options">
                    <button type="submit" name="analyze_type" value="section" class="analysis-btn {% if analyze_type == 'section' %}active{% endif %}">
                        üìä –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ä–∞–∑–¥–µ–ª
                    </button>
                    <span class="or-text">–∏–ª–∏</span>
                    <div class="category-selector">
                        <select name="category_id" id="category_select">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é --</option>
                            {% for category in section_categories %}
                            <option value="{{ category.id }}" {% if selected_category_id == category.id|stringformat:"i" %}selected{% endif %}>
                                {{ category.full_path }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" name="analyze_type" value="category" class="category-analysis-btn">
                            –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </form>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    {% if analysis_results %}
    <div class="analysis-results">
        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞: 
            <span class="analysis-target">
                {% if analyze_type == 'section' %}
                –†–∞–∑–¥–µ–ª "{{ selected_section.title }}"
                {% else %}
                –ö–∞—Ç–µ–≥–æ—Ä–∏—è "{{ analysis_results.full_path }}"
                {% endif %}
            </span>
        </h4>
        
        <div class="stats-grid detailed">
            <div class="stat-card detailed">
                <div class="stat-icon">üì∞</div>
                <div class="stat-info">
                    <div class="stat-number">{{ analysis_results.total_news }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                    <div class="stat-period">(—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)</div>
                </div>
            </div>
            <div class="stat-card detailed">
                <div class="stat-icon">üìÅ</div>
                <div class="stat-info">
                    <div class="stat-number">{{ analysis_results.total_files }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
                    <div class="stat-period">(—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)</div>
                </div>
            </div>
            <div class="stat-card detailed">
                <div class="stat-icon">üëÅÔ∏è</div>
                <div class="stat-info">
                    <div class="stat-number">{{ analysis_results.total_views }}</div>
                    <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                    <div class="stat-period">(—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)</div>
                </div>
            </div>
            <div class="stat-card detailed">
                <div class="stat-icon">üì•</div>
                <div class="stat-info">
                    <div class="stat-number">{{ analysis_results.total_downloads }}</div>
                    <div class="stat-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤</div>
                    <div class="stat-period">(—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)</div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        {% if analysis_results.subdivision_stats %}
        <div class="subdivision-stats detailed">
            <h5>üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º:</h5>
            <div class="subdivision-list">
                {% for subdivision, count in analysis_results.subdivision_stats.items %}
                <div class="subdivision-item">
                    <span class="subdivision-name">{{ subdivision }}</span>
                    <span class="subdivision-count">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if analysis_results.categories_stats %}
        <div class="categories-breakdown">
            <h5>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</h5>
            <div class="categories-stats-list">
                {% for category in analysis_results.categories_stats %}
                <div class="category-stat-item">
                    <div class="category-name">{{ category.full_path }}</div>
                    <div class="category-stats">
                        <span class="cat-stat">üì∞ {{ category.news_count }}</span>
                        <span class="cat-stat">üìÅ {{ category.files_count }}</span>
                        <span class="cat-stat">üëÅÔ∏è {{ category.views_count }}</span>
                        <span class="cat-stat">üì• {{ category.downloads_count }}</span>
                    </div>
                    {% if category.subdivision_stats %}
                    <div class="category-subdivisions">
                        {% for subdivision, count in category.subdivision_stats.items %}
                        <span class="subdivision-badge">{{ subdivision }}: {{ count }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.stats-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-container h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.stats-grid.detailed {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    margin: 20px 0;
}

.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.stat-card.detailed {
    display: flex;
    align-items: center;
    text-align: left;
    padding: 20px;
}

.stat-icon {
    font-size: 2rem;
    margin-right: 15px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 3px;
}

.stat-period {
    color: #95a5a6;
    font-size: 0.8rem;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º */
.subdivision-stats {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.subdivision-stats.detailed {
    margin-top: 25px;
}

.subdivision-stats h4, .subdivision-stats h5 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.subdivision-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.subdivision-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.subdivision-name {
    font-weight: 500;
    color: #2c3e50;
}

.subdivision-count {
    background: #3498db;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
}

.category-subdivisions {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.subdivision-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 0.75rem;
    border: 1px solid #bbdefb;
}

/* –§–æ—Ä–º—ã */
.detailed-stats-form {
    margin-bottom: 20px;
}

.form-row {
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: bold;
    color: #2c3e50;
}

.form-group select {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    max-width: 400px;
}

.analysis-options {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.analysis-btn {
    padding: 12px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.3s ease;
}

.analysis-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

.analysis-btn.active {
    background: #e74c3c;
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
}

.or-text {
    color: #7f8c8d;
    font-weight: bold;
}

.category-selector select {
    min-width: 250px;
}

/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ */
.analysis-results {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

.analysis-target {
    color: #e74c3c;
    font-weight: bold;
}

.categories-breakdown {
    margin-top: 25px;
}

.categories-breakdown h5 {
    color: #34495e;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.categories-stats-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.category-stat-item {
    display: flex;
    flex-direction: column;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #3498db;
}

.category-name {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 8px;
}

.category-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 8px;
}

.cat-stat {
    background: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85rem;
    color: #2c3e50;
    border: 1px solid #dee2e6;
}

/* –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º */
.filter-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: bold;
    color: #2c3e50;
}

.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-btn {
    padding: 8px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
}

.filter-btn.reset {
    background: #95a5a6;
}

.filter-btn:hover {
    opacity: 0.9;
}

.filter-help {
    margin-top: 10px;
    color: #7f8c8d;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid.detailed {
        grid-template-columns: 1fr;
    }
    
    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .analysis-options {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .category-stat-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .category-stats {
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .form-group select {
        max-width: 100%;
    }
    
    .category-selector select {
        min-width: 200px;
    }
    
    .subdivision-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .category-subdivisions {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –∫–∞–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('end_date').max = today;
    document.getElementById('start_date').max = today;
});
</script>
{% endblock %}