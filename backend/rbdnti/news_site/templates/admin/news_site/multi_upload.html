{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<style>
.upload-info {
    background: #f8f8f8;
    border: 1px solid #ddd;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
}
.file-list {
    margin-top: 10px;
}
.file-list ul {
    margin: 5px 0;
    padding-left: 20px;
    max-height: 200px;
    overflow-y: auto;
}
.current-files {
    margin-top: 20px;
}
.current-files table {
    width: 100%;
    border-collapse: collapse;
}
.current-files th,
.current-files td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}
.submit-row {
    padding: 12px 14px;
    margin: 0 0 20px;
    background: #f8f8f8;
    border: 1px solid #eee;
    border-radius: 4px;
    overflow: hidden;
}
.news-info {
    background: #e7f3ff;
    border: 1px solid #b8daff;
    padding: 15px;
    margin: 10px 0;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>{{ title }}</h1>
    
    <div class="news-info">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤–æ—Å—Ç–∏:</h3>
        <p><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> {{ news.title }}</p>
        <p><strong>–°–µ–∫—Ü–∏—è:</strong> {{ news.section.title }}</p>
        {% if news.category %}
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ news.category.get_full_path }}</p>
        {% endif %}
        <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ news.created_at|date:"d.m.Y H:i" }}</p>
    </div>
    
    <div class="module">
        <form method="post" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}
            
            <div class="form-row">
                <label for="id_files"><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</strong></label>
                <input type="file" name="files" multiple id="id_files" style="margin: 10px 0; padding: 8px;">
                <div class="help">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (–∏–ª–∏ Cmd –Ω–∞ Mac) –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤</div>
            </div>
            <input type="hidden" name="news_id" value="{{ news.id }}">
            
            <div class="upload-info" id="upload-info" style="display: none;">
                <p><strong>–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: <span id="file-count">0</span></strong></p>
                <div id="file-list"></div>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" class="default" style="padding: 10px 20px;">
                <a href="/admin/news_site/news/{{ news.id }}/change/" class="button" style="padding: 10px 20px; margin-left: 10px;">‚úèÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–æ–≤–æ—Å—Ç–∏</a>
                <a href="/admin/news_site/news/" class="button" style="padding: 10px 20px; margin-left: 10px;">üìã –ö —Å–ø–∏—Å–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π</a>
            </div>
        </form>
    </div>
    
    {% if news.files.all %}
    <div class="module current-files">
        <h2>–¢–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã –Ω–æ–≤–æ—Å—Ç–∏ ({{ news.files.count }})</h2>
        <table>
            <thead>
                <tr>
                    <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for file in news.files.all %}
                <tr>
                    <td>{{ file.filename }}</td>
                    <td>
                        {% if file.file.size %}
                            {{ file.file.size|filesizeformat }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ file.file.url }}" download class="button">üì• –°–∫–∞—á–∞—Ç—å</a>
                        <a href="/admin/news_site/newsfile/{{ file.id }}/change/" class="button">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="module">
        <p>–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_files');
    const uploadInfo = document.getElementById('upload-info');
    const fileCount = document.getElementById('file-count');
    const fileList = document.getElementById('file-list');
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            let html = '<ul>';
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                const size = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '?';
                html += `<li>${file.name} <small>(${size})</small></li>`;
            }
            html += '</ul>';
            
            fileCount.textContent = this.files.length;
            fileList.innerHTML = html;
            uploadInfo.style.display = 'block';
        } else {
            uploadInfo.style.display = 'none';
        }
    });
    
    // –£–±–∏—Ä–∞–µ–º beforeunload - —ç—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    const form = document.getElementById('upload-form');
    form.addEventListener('submit', function() {
        window.removeEventListener('beforeunload', preventUnload);
    });
});
</script>
{% endblock %}