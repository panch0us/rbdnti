{% extends "news_site/base.html" %}

{% block title %}Статистика - РБД НТИ{% endblock %}

{% block content %}
<!-- Хлебные крошки -->
<nav class="breadcrumb">
    <span class="breadcrumb-item">
        <a href="{% url 'news_site:index' %}">Главная</a>
    </span>
    <span class="breadcrumb-item active">Статистика</span>
</nav>

<h1 class="section-title">Статистика РБД НТИ</h1>

<!-- Фильтр по датам -->
<div class="stats-container">
    <h3>Фильтр по дате</h3>
    <form method="get" class="date-filter-form">
        <div class="filter-row">
            <div class="filter-group">
                <label for="start_date">С:</label>
                <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="filter-group">
                <label for="end_date">По:</label>
                <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <button type="submit" class="filter-btn">Применить</button>
            <a href="{% url 'news_site:statistics' %}" class="filter-btn reset">Сбросить</a>
        </div>
        <div class="filter-help">
        {% if start_date or end_date %}
            Показаны данные за период: 
            {% if start_date %}{{ start_date }}{% else %}начала времен{% endif %} 
            - 
            {% if end_date %}{{ end_date }}{% else %}сегодня{% endif %}
        {% else %}
            Показаны все данные
        {% endif %}
        </div>
    </form>
</div>

<!-- 1. Всего материалов размещено -->
<div class="stats-container">
    <h3>1. Всего материалов размещено в РБД НТИ</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_news }}</div>
            <div class="stat-label">Всего новостей</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_news_period }}</div>
            <div class="stat-label">Новостей за период</div>
        </div>
    </div>
</div>

<!-- 2. Статистика размещения по периодам -->
<div class="stats-container">
    <h3>2. Статистика размещения материалов по периодам</h3>
    
    <div class="stats-tabs">
        <button class="tab-button active" onclick="openTab(event, 'news-years')">По годам</button>
        <button class="tab-button" onclick="openTab(event, 'news-quarters')">По кварталам ({{ current_year }})</button>
        <button class="tab-button" onclick="openTab(event, 'news-months')">По месяцам ({{ current_year }})</button>
    </div>
    
    <div id="news-years" class="tab-content active">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Год</th>
                    <th>Количество новостей</th>
                </tr>
            </thead>
            <tbody>
                {% for item in news_by_year %}
                <tr>
                    <td>{{ item.created_at__year }}</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="news-quarters" class="tab-content">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Квартал</th>
                    <th>Количество новостей</th>
                </tr>
            </thead>
            <tbody>
                {% for item in news_by_quarter %}
                <tr>
                    <td>{{ item.quarter }} квартал</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="news-months" class="tab-content">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Месяц</th>
                    <th>Количество новостей</th>
                </tr>
            </thead>
            <tbody>
                {% for item in news_by_month %}
                <tr>
                    <td>
                        {% if item.month == 1 %}Январь
                        {% elif item.month == 2 %}Февраль
                        {% elif item.month == 3 %}Март
                        {% elif item.month == 4 %}Апрель
                        {% elif item.month == 5 %}Май
                        {% elif item.month == 6 %}Июнь
                        {% elif item.month == 7 %}Июль
                        {% elif item.month == 8 %}Август
                        {% elif item.month == 9 %}Сентябрь
                        {% elif item.month == 10 %}Октябрь
                        {% elif item.month == 11 %}Ноябрь
                        {% elif item.month == 12 %}Декабрь
                        {% endif %}
                    </td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<!-- 3. Всего материалов просмотрено/скачано -->
<div class="stats-container">
    <h3>3. Всего материалов просмотрено / скачано</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_views }}</div>
            <div class="stat-label">Всего просмотров</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_downloads }}</div>
            <div class="stat-label">Всего скачиваний</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_views_period }}</div>
            <div class="stat-label">Просмотров за период</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_downloads_period }}</div>
            <div class="stat-label">Скачиваний за период</div>
        </div>
    </div>
</div>

<!-- 4. Статистика просмотров/скачиваний по периодам -->
<div class="stats-container">
    <h3>4. Статистика просмотров и скачиваний по периодам</h3>
    
    <div class="stats-tabs">
        <button class="tab-button active" onclick="openTab(event, 'activity-years')">По годам</button>
        <button class="tab-button" onclick="openTab(event, 'activity-quarters')">По кварталам ({{ current_year }})</button>
        <button class="tab-button" onclick="openTab(event, 'activity-months')">По месяцам ({{ current_year }})</button>
    </div>
    
    <div id="activity-years" class="tab-content active">
        <h4>Просмотры по годам</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Год</th>
                    <th>Количество просмотров</th>
                </tr>
            </thead>
            <tbody>
                {% for item in views_by_year %}
                <tr>
                    <td>{{ item.created_at__year }}</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h4>Скачивания по годам</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Год</th>
                    <th>Количество скачиваний</th>
                </tr>
            </thead>
            <tbody>
                {% for item in downloads_by_year %}
                <tr>
                    <td>{{ item.downloaded_at__year }}</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="activity-quarters" class="tab-content">
        <h4>Просмотры по кварталам ({{ current_year }})</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Квартал</th>
                    <th>Количество просмотров</th>
                </tr>
            </thead>
            <tbody>
                {% for item in views_by_quarter %}
                <tr>
                    <td>{{ item.quarter }} квартал</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h4>Скачивания по кварталам ({{ current_year }})</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Квартал</th>
                    <th>Количество скачиваний</th>
                </tr>
            </thead>
            <tbody>
                {% for item in downloads_by_quarter %}
                <tr>
                    <td>{{ item.quarter }} квартал</td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div id="activity-months" class="tab-content">
        <h4>Просмотры по месяцам ({{ current_year }})</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Месяц</th>
                    <th>Количество просмотров</th>
                </tr>
            </thead>
            <tbody>
                {% for item in views_by_month %}
                <tr>
                    <td>
                        {% if item.month == 1 %}Январь
                        {% elif item.month == 2 %}Февраль
                        {% elif item.month == 3 %}Март
                        {% elif item.month == 4 %}Апрель
                        {% elif item.month == 5 %}Май
                        {% elif item.month == 6 %}Июнь
                        {% elif item.month == 7 %}Июль
                        {% elif item.month == 8 %}Август
                        {% elif item.month == 9 %}Сентябрь
                        {% elif item.month == 10 %}Октябрь
                        {% elif item.month == 11 %}Ноябрь
                        {% elif item.month == 12 %}Декабрь
                        {% endif %}
                    </td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h4>Скачивания по месяцам ({{ current_year }})</h4>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Месяц</th>
                    <th>Количество скачиваний</th>
                </tr>
            </thead>
            <tbody>
                {% for item in downloads_by_month %}
                <tr>
                    <td>
                        {% if item.month == 1 %}Январь
                        {% elif item.month == 2 %}Февраль
                        {% elif item.month == 3 %}Март
                        {% elif item.month == 4 %}Апрель
                        {% elif item.month == 5 %}Май
                        {% elif item.month == 6 %}Июнь
                        {% elif item.month == 7 %}Июль
                        {% elif item.month == 8 %}Август
                        {% elif item.month == 9 %}Сентябрь
                        {% elif item.month == 10 %}Октябрь
                        {% elif item.month == 11 %}Ноябрь
                        {% elif item.month == 12 %}Декабрь
                        {% endif %}
                    </td>
                    <td>{{ item.count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Нет данных за {{ current_year }} год</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Дополнительная статистика -->
<div class="stats-container">
    <h3>Дополнительная статистика</h3>
    
    <div class="stats-sidebyside">
        <div class="side-panel">
            <h4>Самые просматриваемые новости</h4>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Новость</th>
                        <th>Просмотры</th>
                    </tr>
                </thead>
                <tbody>
                    {% for news in popular_news %}
                    <tr>
                        <td>{{ news.title }}</td>
                        <td>{{ news.views_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="side-panel">
            <h4>Самые скачиваемые файлы</h4>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Файл</th>
                        <th>Скачивания</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in popular_files %}
                    <tr>
                        <td>{{ file.filename }}</td>
                        <td>{{ file.downloads_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <h4>Последние скачивания</h4>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Время</th>
                <th>Файл</th>
                <th>IP-адрес</th>
                <th>User Agent</th>
            </tr>
        </thead>
        <tbody>
            {% for download in recent_downloads %}
            <tr>
                <td>{{ download.downloaded_at|date:"d.m.Y H:i" }}</td>
                <td>{{ download.news_file.filename }}</td>
                <td>{{ download.ip_address }}</td>
                <td title="{{ download.user_agent }}">
                    {{ download.user_agent|truncatechars:50 }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.stats-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-container h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    border-bottom: 2px solid #e74c3c;
    padding-bottom: 5px;
}

.stats-container h4 {
    color: #34495e;
    margin: 20px 0 10px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
}

/* Фильтры */
.date-filter-form {
    margin-bottom: 15px;
}

.filter-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: bold;
    color: #2c3e50;
}

.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-btn {
    padding: 8px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
}

.filter-btn.reset {
    background: #95a5a6;
}

.filter-btn:hover {
    opacity: 0.9;
}

.filter-help {
    margin-top: 10px;
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* Табы */
.stats-tabs {
    display: flex;
    border-bottom: 1px solid #ddd;
    margin-bottom: 15px;
}

.tab-button {
    padding: 10px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 14px;
    color: #7f8c8d;
}

.tab-button:hover {
    color: #3498db;
}

.tab-button.active {
    color: #3498db;
    border-bottom-color: #3498db;
    font-weight: bold;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Таблицы */
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    margin-bottom: 20px;
}

.stats-table th,
.stats-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
    font-size: 0.9rem;
}

.stats-table th {
    background: #f8f9fa;
    font-weight: bold;
    color: #2c3e50;
}

.stats-table tr:hover {
    background: #f8f9fa;
}

/* Боковые панели */
.stats-sidebyside {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.side-panel {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
}

@media (max-width: 768px) {
    .stats-sidebyside {
        grid-template-columns: 1fr;
    }
    
    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tabbuttons;
    
    // Скрываем все табы
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    
    // Убираем активный класс со всех кнопок
    tabbuttons = document.getElementsByClassName("tab-button");
    for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
    }
    
    // Показываем текущий таб и делаем кнопку активной
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

// Устанавливаем сегодняшнюю дату как максимальную для фильтров
document.addEventListener('DOMContentLoaded', function() {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('end_date').max = today;
    document.getElementById('start_date').max = today;
});
</script>
{% endblock %}