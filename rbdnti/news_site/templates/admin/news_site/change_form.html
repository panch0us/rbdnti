{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block object-tools-items %}
    {{ block.super }}
    <li>
        {% if original %}
            {# –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ–≤–æ—Å—Ç–∏ - –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ #}
            <a href="{% url 'admin:news_upload_files' original.pk %}" class="historylink" style="background: #417690; color: white; padding: 8px 12px; border-radius: 4px; text-decoration: none;">
                üìÅ –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            </a>
        {% else %}
            {# –î–ª—è –Ω–æ–≤–æ–π –Ω–æ–≤–æ—Å—Ç–∏ - –∫–Ω–æ–ø–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ #}
            <a href="javascript:void(0)" class="historylink" style="background: #79aec8; color: white; padding: 8px 12px; border-radius: 4px; text-decoration: none; cursor: pointer;" 
               onclick="handleMassUploadClick()">
                üìÅ –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            </a>
        {% endif %}
    </li>
{% endblock %}

{% block admin_change_form_document_ready %}
{{ block.super }}
<script>
function handleMassUploadClick() {
    // –ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
    const saveAndContinueBtn = document.querySelector('input[name="_continue"]');
    if (saveAndContinueBtn) {
        saveAndContinueBtn.click();
    }
}

// –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –¥–ª—è –Ω–æ–≤–æ–π –Ω–æ–≤–æ—Å—Ç–∏
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('news_form');
    const isNewNews = window.location.href.includes('/add/');
    
    if (form && isNewNews) {
        let isMassUpload = false;
        
        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        const massUploadBtn = document.querySelector('[onclick="handleMassUploadClick()"]');
        if (massUploadBtn) {
            massUploadBtn.addEventListener('click', function() {
                isMassUpload = true;
            });
        }
        
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(e) {
            if (isMassUpload) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π action
                const originalAction = form.action;
                
                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –∑–∞—Ç–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
                setTimeout(function() {
                    // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å ID –Ω–æ–≤–æ—Å—Ç–∏
                    const checkRedirect = setInterval(function() {
                        const currentUrl = window.location.href;
                        const newsIdMatch = currentUrl.match(/\/news\/(\d+)\/change\//);
                        
                        if (newsIdMatch && newsIdMatch[1]) {
                            clearInterval(checkRedirect);
                            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤
                            window.location.href = `/admin/news_site/news/${newsIdMatch[1]}/upload-files/`;
                        }
                    }, 100);
                }, 500);
            }
        });
    }
});
</script>
{% endblock %}